<!DOCTYPE html>

<html>
<link rel="icon" href="./src/img/favicon.ico">

<head>
</head>

<body>



  <div class="site">

    <div class="header">
      <div class="toolbar">
        <div class="site-title-container">
          <h1>Block Rule Composer <i class="fas fa-puzzle-piece"></i></h1>
        </div>

        <div class="utility-buttons-container">
          <div class="user-content">

            <div id="logged-button-section">
              <span id="user-name"></span>

              <!--
            <button id="suggestor-drop" class="pure-button" type="button">
              Move hint to main
            </button>
            -->

              <button id="button-home" class="pure-button" type="button"
                onclick="location.href='https://giove.isti.cnr.it/demo/pat/nors/index.html'" ;>
                Back to home
              </button>
              <!--
              <button id="button-modal-export" class="pure-button" type="button">
                Export workspace
              </button>
            -->
              <button id="button-modal-check" class="pure-button" type="button">
                Check rule
              </button>
              <button id="button-modal-new" class="pure-button" type="button">
                New rule
              </button>
              <button id="button-modal-save" class="pure-button" type="button">
                Save rule
              </button>
              <button data-micromodal-trigger="modal-2" id="button-modal-get" class="pure-button" type="button">
                My rules
              </button>
               <!--
               <button data-micromodal-trigger="modal-2" id="button-modal-get-all" class="pure-button" type="button">
                All rules
              </button>
               <button data-micromodal-trigger="modal-import" id="button-modal-import" class="pure-button" type="button">
                Import rule
              </button>
            -->
            </div>
          </div>
          <!--
    <div class="login-logout-container">
      <span id="google-signin" class="g-signin2"></span>
      <span id="google-signout" hidden="true"><a id="google-signout-text" href=""></a></span>
    </div>
    -->

        </div>

      </div>
    </div>

    <div class="workspaces-container">
      <div id="main-workspace-div"></div>
      <div id="suggestion-workspace-container">
        <div id="suggestion-workspace-title">
          <div id="suggestion-workspace-title-text">Recommendations area</div>
        </div>
        <div id="suggestion-workspace-div"></div>
      </div>
    </div>

    <div class="support-container">

      <div class="textarea-container">
        <div class="textarea-div">
          <div id="textarea-suggestor">

            <div>
              <button id="suggestor-and" class="pure-button" type="button" disabled>
                AND
              </button>
            </div>
            <div>
              <button id="suggestor-or" class="pure-button" type="button" disabled>
                OR
              </button>
            </div>
            <div>
              <button id="suggestor-not" class="pure-button" type="button" disabled>
                NOT
              </button>
            </div>
          </div>
        </div>

        <div class="textarea-div" >
          <div id="textarea-suggestion-expl"> </div>
        </div>

        <div class="textarea-div">
          <div id="textarea-alerts"></div>
        </div>

        <div class="textarea-div">
          <div id="textarea-connections-check"></div>
        </div>
      </div>

      <div class="change-type-div">

        <div class="pure-menu pure-menu-horizontal">
          <ul class="pure-menu-list">
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link disabled-element" id="suggestor-step-by-step">Step-by-step</a>
            </li>
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link disabled-element" id="suggestor-full-rule">Full rule</a>
            </li>
            <li class="pure-menu-item">
              <a href="#" class="pure-menu-link" id="suggestor-none">None</a>
            </li>
          </ul>
        </div>
        <div id="rec-type-text-div" class="rec-type-text">
          Suggestions disabled
        </div>
      </div>
    </div>
  </div>

  <xml id="toolbox" style="display: hidden">
    <category name="Rule block">
      <block type="rule"></block>
    </category>

    <category id="trigger_list" name="Trigger list">
    </category>

    <category name="Trigger operators">
      <block type="and"></block>
      <block type="or"></block>
    </category>

    <category name="Action list">
    </category>


  </xml>

  <xml id="startBlocks" style="visibility: hidden">
    <block type="rule" inline="false" x="20" y="20">
    </block>
  </xml>


  <!-- modal save rule form -->
  <div class="modal micromodal-slide" id="modal-1" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-1-title">
            Save rule
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-1-content">
          <form action="/my-handling-form-page" method="post">
            <div class="form-elements">
              <label for="rule_name">Name:</label>
              <input type="text" id="rule_name" name="rule_name" required>
            </div>
            <div class="form-elements">
              <label for="priority">Priority:</label>
              <input type="number" min="1" max="10" id="priority" name="priority">
            </div>
            <div class="form-elements">
              <label for="goal">Goal:</label>
              <select name="goal" id="goal">
                <option value="none">--none--</option>
                <option value="safety">Safety</option>
                <option value="health">Health</option>
                <option value="wellbeing">Well-being</option>
                <option value="comfort">Comfort</option>
              </select>
            </div>
          </form>
        </main>
        <footer class="modal__footer">
          <button id="button-confirm-save" class="pure-button" data-micromodal-close
            aria-label="Save this rule">Save</button>
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>


  <!-- modal get rule form -->
  <div class="modal micromodal-slide" id="modal-2" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-2-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-2-title">
            My rules
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-2-content">
          <div class="rule-list-container">
            <p id="rule_list">
            </p>
          </div>
        </main>
        <footer class="modal__footer">
          <div id="modal-footer-buttons-container">
            <div id="modal-footer-left-buttons">
              <button id="button-confirm-get" class="pure-button" data-micromodal-close aria-label="Get this rule">Load rule</button>
              <button id="button-delete" class="pure-button" data-micromodal-close aria-label="Delete this rule">Delete rule</button>
              <button id="button-export-all" class="pure-button" data-micromodal-close
                aria-label="Export all rules">Export
                all rules
              </button>
              <button id="button-activate" class="pure-button" data-micromodal-close
                aria-label="Activate this rule">Activate rule</button>
              <button id="button-deactivate" class="pure-button" data-micromodal-close
                aria-label="Deactivate this rule">Deactivate rule</button>
            </div>
            <div class="modal-footer-right-buttons">
              <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
            </div>
          </div>
        </footer>
      </div>
    </div>
  </div>
  
  <!-- modal import rule form -->
  <div class="modal micromodal-slide" id="modal-import" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-2-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-2-title">
            Import rules
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-2-content">
        	<div class="import-widget">
            <header><h4 class="standard-font  text-center">Import a XML Blockly rule</h4></header>
            <div id="file-drop">Drop files here!</div>
          </div>
          <div id = "messages"></div>
        </main>
        <footer class="modal__footer">
          <div id="modal-footer-buttons-container">
            <div id="modal-footer-left-buttons">
              <button id="button-confirm-import" class="pure-button" data-micromodal-close aria-label="Import this rule">Import rule</button>
            <div class="modal-footer-right-buttons">
              <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
            </div>
          </div>
        </footer>
      </div>
    </div>
  </div>

  <!-- modal event - condition change -->
  <div class="modal micromodal-slide" id="modal-event-condition-change" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-3-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-event-condition-change-title">
            Change trigger type
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-3-content">
          <div class="grid-container-event-condition">
            <div class="event-icon">
              <p> <img src="src/img/event.jpeg"> </p>
            </div>
            <div class="event-desc">
              <p> Punctual happening in a time frame </p>
            </div>
            <div class="event-examples">
              <p>
                - when user enters a room, <br>
                - when it starts to rain, <br>
                - when kitchen temperature exceedes 30 degrees, <br>
                - at 8 o'clock
              </p>
            </div>
            <div class="event-button">
              <p>
                <button class="pure-button" id="custom-dialog-event-change">Event</button>
              </p>
            </div>
            <div class="condition-icon">
              <p> <img src="src/img/condition.jpeg"> </p>
            </div>
            <div class="condition-desc">
              <p> Protracted state in a time frame </p>
            </div>
            <div class="condition-examples">
              <p>
                - while user is inside a room, <br>
                - as long as it's raining, <br>
                - while kitchen temperature is over 30 degrees, <br>
                - between 20:00 and 23:30
              </p>
            </div>
            <div class="condition-button">
              <p>
                <button class="pure-button" id="custom-dialog-condition-change">Condition</button>
              </p>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- modal warning event and event -->
  <div class="modal micromodal-slide" id="modal-event-event" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-3-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-event-event-title">
            Attenzione
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-3-content">
          <p>E' molto improbabile che due eventi accadano esattamente nello stesso momento.</p>
          <p>Dovresti cambiare uno degli eventi in "Condizione".</p>
        </main>
        <footer class="modal__footer">
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- modal check rule -->
  <div class="modal micromodal-slide" id="modal-check" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-4-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-check-title">
            Check rule
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-check-content">
          <p>
          </p>
        </main>
        <footer class="modal__footer">
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>
  
  <!-- modal warnings -->
  <div class="modal micromodal-slide" id="modal-warning" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
      <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-5-title">
        <header class="modal__header">
          <h2 class="modal__title" id="modal-check-title">
            Warning
          </h2>
          <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
        </header>
        <main class="modal__content" id="modal-warning-content">
          <p>
          </p>
        </main>
        <footer class="modal__footer">
          <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
        </footer>
      </div>
    </div>
  </div>


  </div>

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
    integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="src/css/micromodal.css">
  <link rel="stylesheet" type="text/css" href="src/css/editor.css">
  <script src="node_modules/jquery/dist/jquery.js"></script>
  <script src="https://apis.google.com/js/platform.js"></script>
  <script src="node_modules/file-saver/dist/FileSaver.js"></script>
  <script src="https://kit.fontawesome.com/6f52fd3181.js"></script>
  <script src="node_modules/micromodal/dist/micromodal.js"></script>
  <script src="node_modules/blockly/blockly_compressed.js"></script>
  <script src="node_modules/blockly/javascript_compressed.js"></script>
  <script src="node_modules/blockly/msg/js/en.js"></script>
  <script src="node_modules/blockly/blocks/text.js"></script>
  <script src="node_modules/blockly/blocks/loops.js"></script>
  <script src="node_modules/blockly/blocks/logic.js"></script>
  <script src="node_modules/blockly/blocks/lists.js"></script>
  <script src="node_modules/blockly/blocks/colour.js"></script>
  <script src="node_modules/blockly/blocks/variables.js"></script>
  <script src="node_modules/blockly/blocks/variables_dynamic.js"></script>
  <script src="src/js/staticBlocks.js"></script>
  <script src="src/js/colour-gradient.js"></script>
  <script type="module" src="src/js/main.js"></script>
  <script src="src/js/dynamicBlocks.js"></script>
  <script type="module">
    import * as Login from './src/js/login.js';
    import {
      saveUserToLocal, checkRuleStructure, checkRuleMeaning,
      exportSuggestorDrop,
      getWorkspace, exportWorkspace, getRuleSuggestorStatus,
      getLastBlock, newRule, exportAllRules, eventChange, conditionChange,
    } from './src/js/main.js';
    import {
      saveRuleInDB, getAllFromDB, getOneFromDB, deleteRule,
      activateRule, deactivateRule, getAllFromDBUser
    } from './src/js/database_functs.js';
    import { appendRulesList, getFullRule, xmlFileToWorkspace } from './src/js/dom_modifiers.js';
    import { changeRecTypeDiv } from './src/js/textarea_manager.js';
    MicroModal.init();

    /**
     * Aggiunge un parametro alla funzione assegnata al bottone button-modal-get 
     */
    function buttonGetMyRules() {
      appendRulesList("rule_list");
    }

    /**
     * Aggiunge un parametro alla funzione assegnata al bottone button-modal-get 
     */
    function buttonGetAllRules() {
      appendRulesList("rule_list", true);
    }
    
    /**
     * Controlla che il workspace sia nello stato corretto per il salvataggio
     * prima di mostrare la finestra modale di conferma salvataggio
     */
    function saveRuleWrapper() {
      let checkStatus = checkRuleStructure();
      if (checkStatus === "OK") {
        document.getElementById('textarea-alerts').innerHTML = "";
        document.getElementById('textarea-alerts').innerHTML = "Check: " + checkStatus + ", Saving";
        MicroModal.show('modal-1');
      }
      else {
        document.getElementById('textarea-alerts').innerHTML = "";
        document.getElementById('textarea-alerts').innerHTML = "Can't save: " + checkStatus;
        // If rule is not saved it is a problem: better show also a modal
        MicroModal.show('modal-warning');
        document.getElementById('modal-warning-content').innerHTML = "";
        document.getElementById('modal-warning-content').innerHTML = "Can't save: " + checkStatus;
      }
    }

    /**
     * Controlla che la regola attualmente nel workspace sia corretta 
     */
    function checkRuleWrapper() {
      let checkStructure = checkRuleStructure();
      //let checkMeaning = checkRuleMeaning(); TODO
      let result =
        `
      Rule structure: ${checkStructure} <br> 
      `
      MicroModal.show('modal-check');
      document.getElementById('modal-check-content').innerHTML = "";
      document.getElementById('modal-check-content').innerHTML = result;
    }


    //const buttonUsername = document.getElementById("button-username");
    //buttonUsername.addEventListener("click", saveToLocalWrapper, false);

    //const suggestorDrop = document.getElementById("suggestor-drop");
    //suggestorDrop.addEventListener("click", exportSuggestorDrop, false);

    //const suggestorInfo = document.getElementById("suggestor-info");
    //suggestorInfo.addEventListener("click", showModalSuggestorInfoWrapper, false);

    const buttonSave = document.getElementById("button-modal-save");
    buttonSave.addEventListener("click", saveRuleWrapper, false);

    const buttonCheck = document.getElementById("button-modal-check");
    buttonCheck.addEventListener("click", checkRuleWrapper, false);

    const buttonConfirmSave = document.getElementById("button-confirm-save");
    buttonConfirmSave.addEventListener("click", saveRuleInDB, false);

    const buttonGetAll = document.getElementById("button-modal-get");
    buttonGetAll.addEventListener("click", buttonGetMyRules, false);

    //const buttonGetAllAllUsers = document.getElementById("button-modal-get-all");
    //buttonGetAllAllUsers.addEventListener("click", buttonGetAllRules, false);
    
    const buttonExportWorkspace = document.getElementById("button-modal-export");
    buttonExportWorkspace.addEventListener("click", exportWorkspace, false);
    
    const buttonExportAll = document.getElementById("button-export-all");
    buttonExportAll.addEventListener("click", exportAllRules, false);

    const buttonNew = document.getElementById("button-modal-new");
    buttonNew.addEventListener("click", newRule, false);

    const buttonGetOne = document.getElementById("button-confirm-get");
    buttonGetOne.addEventListener("click", getFullRule, false);

    const buttonDelete = document.getElementById("button-delete");
    buttonDelete.addEventListener("click", deleteRule, false);

    const buttonActivate = document.getElementById("button-activate");
    buttonActivate.addEventListener("click", activateRule, false);

    const buttonDeactivate = document.getElementById("button-deactivate");
    buttonDeactivate.addEventListener("click", deactivateRule, false);

    const buttonEventChange = document.getElementById("custom-dialog-event-change");
    buttonEventChange.addEventListener("click", eventChange, false);

    const buttonConditionChange = document.getElementById("custom-dialog-condition-change");
    buttonConditionChange.addEventListener("click", conditionChange, false)
   
      let file_drop = document.getElementById('file-drop');
  file_drop.addEventListener(
    'dragover',
    function handleDragOver(evt) {
      evt.stopPropagation()
      evt.preventDefault()
      evt.dataTransfer.dropEffect = 'copy'
    },
    false
  )
  file_drop.addEventListener(
    'drop',
    function(evt) {
      evt.stopPropagation()
      evt.preventDefault()
      var files = evt.dataTransfer.files  // FileList object.
      var file = files[0]                 // File     object.
       $('#messages').append($('<li>').text("File imported"));
        if(file){
          console.log(file);
          readFile(file);
        }
        else {
          console.log("No file!")
        }
    },
    false
  )

    function readFile(file){
    var reader = new FileReader();
    reader.readAsText(file, "UTF-8");
    reader.onload = function (evt) {
      let doc = evt.target.result;
      if(doc){
        xmlFileToWorkspace(doc);
      }
      else {
        console.log("error extracting xml from file")
      }
    }
    reader.onerror = function (evt) {
      console.log("error loading file")
    }
}

  </script>

</body>

</html>